<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Self-Attention ì •ë¦¬</title>
  <style>
    :root {
      --bg: #0b0e14;
      --panel: #111622;
      --text: #e6e6e6;
      --muted: #9aa4b2;
      --accent: #5cc8ff;
      --accent-2: #a78bfa;
      --ok: #34d399;
      --warn: #f59e0b;
      --danger: #ef4444;
      --border: #1f2937;
      --code-bg: #0f1420;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7fafc;
        --panel: #ffffff;
        --text: #0f172a;
        --muted: #475569;
        --accent: #0ea5e9;
        --accent-2: #7c3aed;
        --border: #e2e8f0;
        --code-bg: #f8fafc;
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); line-height: 1.6; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { display: grid; grid-template-columns: 260px 1fr; gap: 20px; padding: 24px; max-width: 1200px; margin: 0 auto; }
    nav { position: sticky; top: 16px; align-self: start; background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 16px; }
    nav h2 { margin: 0 0 12px; font-size: 14px; color: var(--muted); letter-spacing: .02em; }
    nav a { display: block; padding: 8px 10px; border-radius: 10px; color: var(--text); }
    nav a:hover { background: rgba(92,200,255,.1); }
    header.hero { grid-column: 1 / -1; background: linear-gradient(135deg, rgba(92,200,255,.12), rgba(167,139,250,.12)); border: 1px solid var(--border); border-radius: 20px; padding: 28px; }
    .title { display:flex; align-items: center; justify-content: space-between; gap: 12px; }
    h1 { margin: 0; font-size: 28px; }
    .subtitle { color: var(--muted); font-size: 14px; margin-top: 6px; }
    .content { background: var(--panel); border: 1px solid var(--border); border-radius: 20px; padding: 24px; }
    section + section { margin-top: 32px; }
    h2 { font-size: 20px; margin: 0 0 8px; }
    h3 { font-size: 16px; margin: 16px 0 8px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 13px; background: var(--code-bg); color: var(--text); padding: 2px 6px; border-radius: 6px; border: 1px solid var(--border); }
    pre, code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 13px; }
    pre { background: var(--code-bg); border: 1px solid var(--border); border-radius: 14px; padding: 14px; overflow: auto; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 16px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); color: var(--muted); }
    .callout { border-left: 3px solid var(--accent); background: linear-gradient(90deg, rgba(92,200,255,.12), transparent); padding: 12px 12px 12px 14px; border-radius: 12px; }
    .muted { color: var(--muted); }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .btn { display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); background: var(--panel); padding: 8px 12px; border-radius: 999px; cursor:pointer; color: var(--text); }
    .btn:hover { border-color: var(--accent); }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { border: 1px solid var(--border); padding: 8px 10px; text-align: left; }
    .table th { background: rgba(167,139,250,.12); }
    .mono { font-variant-ligatures: none; }
    footer { grid-column: 1 / -1; color: var(--muted); padding: 24px; text-align: center; }
    .chip { display:inline-block; padding: 3px 8px; border:1px dashed var(--border); border-radius: 999px; font-size: 12px; color: var(--muted); }
    .kbd-k { background: var(--bg); border:1px solid var(--border); }
    .note { font-size: 13px; color: var(--muted); }
    .flex { display:flex; gap:16px; flex-wrap: wrap; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <div class="container">
    <header class="hero">
      <div class="title">
        <div>
          <h1>Self-Attention ì •ë¦¬</h1>
          <div class="subtitle">Scaled Dot-Product / Multi-Head / Shape / ë³µì¡ë„ / ê°„ë‹¨ ê³„ì‚°ê¸°</div>
        </div>
        <div class="row">
          <button class="btn" id="toggle-theme" title="í…Œë§ˆ í† ê¸€"><span aria-hidden>ğŸŒ“</span> í…Œë§ˆ</button>
          <a class="btn" href="#calculator">ì‹¤ìŠµ ê³„ì‚°ê¸°ë¡œ ì´ë™</a>
        </div>
      </div>
    </header>

    <nav aria-label="ëª©ì°¨">
      <h2>ëª©ì°¨</h2>
      <a href="#what">1. ë¬´ì—‡ì¸ê°€</a>
      <a href="#sdpa">2. Scaled Dot-Product</a>
      <a href="#shapes">3. í…ì„œ ëª¨ì–‘(Shape)</a>
      <a href="#mha">4. Multi-Head</a>
      <a href="#complexity">5. ì‹œê°„Â·ë©”ëª¨ë¦¬ ë³µì¡ë„</a>
      <a href="#masking">6. ë§ˆìŠ¤í‚¹</a>
      <a href="#impl">7. êµ¬í˜„ ìš”ì•½</a>
      <a href="#calculator">8. ë¯¸ë‹ˆ ê³„ì‚°ê¸°</a>
      <a href="#tips">9. íŒ & ë””ë²„ê¹…</a>
    </nav>

    <main class="content">
      <section id="what">
        <h2>1) Self-Attention ì´ë€?</h2>
        <p>
          ì‹œí€€ìŠ¤ ë‚´ë¶€ í† í°ë“¤ì´ ì„œë¡œë¥¼ <b>ì§ˆì˜(<span class="kbd">Q</span>)</b>, <b>í‚¤(<span class="kbd">K</span>)</b>, <b>ê°’(<span class="kbd">V</span>)</b>ìœ¼ë¡œ ë°”ë¼ë³´ë©° ê´€ë ¨ë„ë¥¼ ê°€ì¤‘í•©ìœ¼ë¡œ ì§‘ê³„í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜ì…ë‹ˆë‹¤.
          í† í° ê°„ ìƒê´€ê´€ê³„ë¥¼ <em>ê¸¸ì´ì™€ ë¬´ê´€í•˜ê²Œ</em> í•œ ë²ˆì— ê³„ì‚°í•  ìˆ˜ ìˆì–´ RNNì˜ ì˜ì¡´ì„± í•œê³„ë¥¼ ì™„í™”í•©ë‹ˆë‹¤.
        </p>
        <div class="callout">
          í•µì‹¬ í•œ ì¤„: <span class="kbd">Attention(Q, K, V) = softmax(QK^T / âˆšd<sub>k</sub>) Â· V</span>
        </div>
      </section>

      <section id="sdpa">
        <h2>2) Scaled Dot-Product Attention</h2>
        <ol>
          <li><b>ìœ ì‚¬ë„</b> : ì ê³± í–‰ë ¬ <span class="kbd">S = QK^T</span></li>
          <li><b>ìŠ¤ì¼€ì¼ë§</b> : <span class="kbd">S / âˆšd<sub>k</sub></span> (ë‚´ì  ë¶„ì‚°ì„ ì•ˆì •í™”)</li>
          <li><b>ë§ˆìŠ¤í‚¹</b> : í•„ìš” ì‹œ <span class="kbd">-âˆ</span> ê°€ì‚°</li>
          <li><b>ì •ê·œí™”</b> : í–‰ë³„ <span class="kbd">softmax</span></li>
          <li><b>ê°€ì¤‘í•©</b> : <span class="kbd">A Â· V</span> â†’ ì¶œë ¥</li>
        </ol>
        <div class="grid">
          <div class="card" style="grid-column: span 12;">
            <h3>ì‘ì€ ì˜ˆì‹œ</h3>
            <pre><code>Q = [[1, 0],
     [0, 1]]
K = [[1, 0],
     [1, 1]]
V = [[1, 2],
     [3, 4]]

S = QK^T = [[1, 1],
            [0, 1]]
A = softmax(S / âˆš2) (í–‰ë³„)
ì¶œë ¥ = A Â· V</code></pre>
            <p class="note">ìˆ˜ì¹˜ ì‹¤ìŠµì€ ì•„ë˜ <a href="#calculator">ë¯¸ë‹ˆ ê³„ì‚°ê¸°</a>ì—ì„œ.</p>
          </div>
        </div>
      </section>

      <section id="shapes">
        <h2>3) í…ì„œ Shape ì •ë¦¬</h2>
        <table class="table mono">
          <thead>
            <tr><th>ê¸°í˜¸</th><th>ì„¤ëª…</th><th>Shape</th></tr>
          </thead>
          <tbody>
            <tr><td>B</td><td>ë°°ì¹˜ í¬ê¸°</td><td>(B, Â·)</td></tr>
            <tr><td>T</td><td>ì‹œí€€ìŠ¤ ê¸¸ì´</td><td>(Â·, T, Â·)</td></tr>
            <tr><td>d<sub>model</sub></td><td>ì„ë² ë”© ì°¨ì›</td><td>(Â·, Â·, d<sub>model</sub>)</td></tr>
            <tr><td>h</td><td>í—¤ë“œ ìˆ˜</td><td>â€”</td></tr>
            <tr><td>d<sub>k</sub>=d<sub>v</sub>=d<sub>model</sub>/h</td><td>í—¤ë“œë‹¹ ì°¨ì›</td><td>â€”</td></tr>
            <tr><td>Q,K,V</td><td>í”„ë¡œì ì…˜ ê²°ê³¼</td><td>(B, h, T, d<sub>k</sub>)</td></tr>
            <tr><td>Attn</td><td>ê°€ì¤‘ì¹˜</td><td>(B, h, T, T)</td></tr>
            <tr><td>ì¶œë ¥</td><td>concat í›„ proj</td><td>(B, T, d<sub>model</sub>)</td></tr>
          </tbody>
        </table>
      </section>

      <section id="mha">
        <h2>4) Multi-Head Attention (MHA)</h2>
        <p>
          ì„œë¡œ ë‹¤ë¥¸ <b>íˆ¬ì˜ í–‰ë ¬</b>ì„ ì‚¬ìš©í•´ ì˜ë¯¸ ê³µê°„ì„ ë¶„í•  íƒìƒ‰í•©ë‹ˆë‹¤. ê° í—¤ë“œëŠ” ë‹¤ë¥¸ íŒ¨í„´(ë¬¸ë²•, ì˜ë¯¸, ìœ„ì¹˜ ë“±)ì— íŠ¹í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
        <pre><code># ê°œë…ì  íŒŒì´í”„ë¼ì¸
X â”€â”€W<sub>Q</sub>â†’ Q â”€â”       â”Œâ”€ softmax(QK^T/âˆšd<sub>k</sub>)V â”€â”
X â”€â”€W<sub>K</sub>â†’ K â”€â”œâ”€ hê°œ â”€â”¤                         â”œâ”€ concat â”€ W<sub>O</sub> â†’ Y
X â”€â”€W<sub>V</sub>â†’ V â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
      </section>

      <section id="complexity">
        <h2>5) ë³µì¡ë„</h2>
        <ul>
          <li><b>ì‹œê°„</b>: <span class="kbd">O(B Â· h Â· TÂ² Â· d<sub>k</sub>)</span> (ì£¼ë¡œ <span class="kbd">QK^T</span>)</li>
          <li><b>ë©”ëª¨ë¦¬</b>: <span class="kbd">O(B Â· h Â· TÂ²)</span> (Attn ê°€ì¤‘ì¹˜ ì €ì¥)</li>
        </ul>
        <div class="callout">
          ê¸´ ì‹œí€€ìŠ¤ì—ì„œëŠ” <span class="kbd">TÂ²</span>ê°€ ë³‘ëª©ì…ë‹ˆë‹¤. í•´ê²°ì±…: <b>ê·¼ì‚¬/í¬ì†Œ/ì„ í˜•</b> ì–´í…ì…˜(Performer, FlashAttention, Longformer ë“±) ì±„íƒ.
        </div>
      </section>

      <section id="masking">
        <h2>6) ë§ˆìŠ¤í‚¹</h2>
        <ul>
          <li><b>íŒ¨ë”© ë§ˆìŠ¤í¬</b> : ë¹„ì–´ìˆëŠ” í† í°ì„ ê°€ë¦¬ê¸°.</li>
          <li><b>ìºì£¼ì–¼(ë¯¸ë˜ê°€ë¦¼) ë§ˆìŠ¤í¬</b> : ì–¸ì–´ëª¨ë¸ì—ì„œ <span class="kbd">i</span>ê°€ <span class="kbd">j &gt; i</span>ë¥¼ ë³´ì§€ ëª»í•˜ê²Œ.</li>
        </ul>
        <pre><code>// ë¡œì§“ Sì— ë§ˆìŠ¤í¬ ì ìš© (ê°€ë ¤ì§„ ê³³ì€ ë§¤ìš° ì‘ì€ ê°’ ë”í•˜ê¸°)
S_masked = S + mask * (-1e9)
A = softmax(S_masked)
</code></pre>
      </section>

      <section id="impl">
        <h2>7) êµ¬í˜„ ìš”ì•½ (PyTorch ìœ ì‚¬ ì˜ì‚¬ì½”ë“œ)</h2>
        <pre><code># X: (B, T, d_model)
Q = X @ W_Q  # (B, T, h*d_k) â†’ reshape (B, h, T, d_k)
K = X @ W_K  # (B, h, T, d_k)
V = X @ W_V  # (B, h, T, d_v)
S = Q @ K.transpose(-1, -2) / sqrt(d_k)      # (B, h, T, T)
S += mask                                   # (ì„ íƒ)
A = softmax(S, dim=-1)
Y = A @ V                                    # (B, h, T, d_v)
Y = concat_heads(Y) @ W_O                    # (B, T, d_model)
</code></pre>
        <div class="note">ì‹¤ì œ êµ¬í˜„ì€ ë°°ì¹˜/í—¤ë“œ ì°¨ì› ìˆœì„œë¥¼ ë°”ê¿€ ìˆ˜ ìˆìœ¼ë©°, ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ fused kernel(ì˜ˆ: FlashAttention)ì„ ì‚¬ìš©í•˜ê¸°ë„ í•©ë‹ˆë‹¤.</div>
      </section>

      <section id="calculator">
        <h2>8) ë¯¸ë‹ˆ ê³„ì‚°ê¸° (Self-Attention: A = softmax(QK^T/âˆšd<sub>k</sub>) Â· V)</h2>
        <p class="note">ì‘ì€ í–‰ë ¬ë¡œ ì‹¤í—˜í•˜ì„¸ìš”. ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ê³  ì¤„ë°”ê¿ˆìœ¼ë¡œ í–‰ì„ êµ¬ë¶„í•©ë‹ˆë‹¤. ì˜ˆ: <span class="kbd">1,0\n0,1</span></p>
        <div class="grid">
          <div class="card" style="grid-column: span 6; min-width: 280px;">
            <h3>ì…ë ¥</h3>
            <label for="q" class="sr-only">Q</label>
            <textarea id="q" rows="5" style="width:100%" class="mono" placeholder="Q (ì˜ˆ)
1,0
0,1"></textarea>
            <label for="k" class="sr-only">K</label>
            <textarea id="k" rows="5" style="width:100%; margin-top:8px" class="mono" placeholder="K (ì˜ˆ)
1,0
1,1"></textarea>
            <label for="v" class="sr-only">V</label>
            <textarea id="v" rows="5" style="width:100%; margin-top:8px" class="mono" placeholder="V (ì˜ˆ)
1,2
3,4"></textarea>
            <div class="row" style="margin-top:8px;">
              <label>ìŠ¤ì¼€ì¼ d<sub>k</sub> = <input id="dk" type="number" value="2" class="kbd kbd-k" style="width:70px"></label>
              <button id="run" class="btn">ê³„ì‚°</button>
              <button id="fill-ex" class="btn" title="ì˜ˆì‹œ ì±„ìš°ê¸°">ì˜ˆì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <button id="clear" class="btn" title="ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
            </div>
          </div>
          <div class="card" style="grid-column: span 6; min-width: 280px;">
            <h3>ê²°ê³¼</h3>
            <div class="chip">S = QK^T</div>
            <pre id="s-out"></pre>
            <div class="chip">A = softmax(S/âˆšd<sub>k</sub>) (í–‰ë³„)</div>
            <pre id="a-out"></pre>
            <div class="chip">ì¶œë ¥ = A Â· V</div>
            <pre id="y-out"></pre>
          </div>
        </div>
      </section>

      <section id="tips">
        <h2>9) íŒ & ë””ë²„ê¹… ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
        <ul>
          <li><b>ìŠ¤ì¼€ì¼</b>ì„ ë¹¼ë¨¹ì§€ ì•Šì•˜ëŠ”ê°€? (<span class="kbd">/âˆšd<sub>k</sub></span>)</li>
          <li><b>ë§ˆìŠ¤í¬</b> ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì¶•ì´ ë§ëŠ”ê°€? (íŒ¨ë”©/ìºì£¼ì–¼)</li>
          <li><b>ì •ê·œí™” ì¶•</b>ì´ ë§ˆì§€ë§‰ ì°¨ì›(<span class="kbd">-1</span>)ì¸ê°€?</li>
          <li>í—¤ë“œ concat í›„ <b>ì¶œë ¥ íˆ¬ì˜</b>(<span class="kbd">W<sub>O</sub></span>)ì„ ì ìš©í–ˆëŠ”ê°€?</li>
          <li>ê¸´ ì‹œí€€ìŠ¤ëŠ” <b>TÂ² ë©”ëª¨ë¦¬</b>ì— ìœ ì˜ â€” <span class="kbd">fp16/bf16</span>, ì²´í¬í¬ì¸íŒ…, FlashAttention ê³ ë ¤.</li>
        </ul>
      </section>
    </main>

    <footer>
      Â© 2025 Self-Attention Quick Guide Â· í•„ìš”í•˜ë©´ ì´ íŒŒì¼ì„ ê·¸ëŒ€ë¡œ <span class="kbd">index.html</span>ë¡œ ì €ì¥í•´ GitHub Pagesì— ì˜¬ë¦¬ì„¸ìš”.
    </footer>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const parseMat = (s) => s.trim().split(/\n+/).filter(Boolean).map(row => row.split(/[,\s]+/).filter(Boolean).map(Number));
    const shape = (M) => [M.length, M[0]?.length || 0];
    const matmul = (A, B) => {
      const [m, k] = shape(A); const [k2, n] = shape(B);
      if (!m || !n || k !== k2) throw new Error("í–‰ë ¬ ê³± ë¶ˆê°€: shape ë¶ˆì¼ì¹˜");
      const C = Array.from({length: m}, () => Array(n).fill(0));
      for (let i=0;i<m;i++) for (let j=0;j<n;j++) {
        let s=0; for (let t=0;t<k;t++) s += A[i][t]*B[t][j]; C[i][j]=s;
      }
      return C;
    };
    const transpose = (A) => A[0] ? A[0].map((_,j)=>A.map(r=>r[j])) : [];
    const softmaxRows = (S) => S.map(row => {
      const m = Math.max(...row);
      const exps = row.map(x => Math.exp(x - m));
      const sum = exps.reduce((a,b)=>a+b,0);
      return exps.map(e => e / sum);
    });
    const fmt = (M) => M.map(r => r.map(x => isFinite(x)? (Math.round(x*1e6)/1e6).toString():"-inf").join("\t")).join("\n");

    $('run').addEventListener('click', () => {
      try {
        const Q = parseMat($('q').value); const K = parseMat($('k').value); const V = parseMat($('v').value);
        const dk = Number($('dk').value || '1');
        if (!Q.length || !K.length || !V.length) throw new Error('Q/K/Vë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        const S = matmul(Q, transpose(K));
        const scaled = S.map(row => row.map(x => x / Math.sqrt(dk)));
        const A = softmaxRows(scaled);
        const Y = matmul(A, V);
        $('s-out').textContent = fmt(S);
        $('a-out').textContent = fmt(A);
        $('y-out').textContent = fmt(Y);
      } catch (e) {
        $('s-out').textContent = e.message;
        $('a-out').textContent = '';
        $('y-out').textContent = '';
      }
    });

    $('fill-ex').addEventListener('click', () => {
      $('q').value = '1,0\n0,1';
      $('k').value = '1,0\n1,1';
      $('v').value = '1,2\n3,4';
      $('dk').value = 2;
    });

    $('clear').addEventListener('click', () => {
      $('q').value = '';
      $('k').value = '';
      $('v').value = '';
      $('s-out').textContent = '';
      $('a-out').textContent = '';
      $('y-out').textContent = '';
    });

    // theme toggle: flips light/dark by toggling a data attribute used by CSS vars (optional)
    const toggleBtn = $('toggle-theme');
    let forced = null; // null=system, 'light' | 'dark'
    const applyTheme = () => {
      if (forced === 'light') {
        document.documentElement.style.colorScheme = 'light';
        document.documentElement.classList.add('light');
      } else if (forced === 'dark') {
        document.documentElement.style.colorScheme = 'dark';
        document.documentElement.classList.remove('light');
      } else {
        document.documentElement.style.colorScheme = 'normal';
      }
    };
    toggleBtn.addEventListener('click', () => {
      forced = forced === 'dark' ? 'light' : (forced === 'light' ? null : 'dark');
      applyTheme();
    });
  </script>
</body>
</html>
